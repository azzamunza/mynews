<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Portal</title>
    <link rel="stylesheet" href="./css/article-magazine.css">
    <link id="themeStylesheet" rel="stylesheet" href="./css/newsStyles/darkstyle.css">
</head>
<body>
<header>
    <div class="header-container">
        <div class="hamburger" id="hamburgerMenu"><span></span><span></span><span></span></div>
        <h1 class="site-title">NewsHub</h1>

        <!-- Reload data button: placed here so it's visible in the header menu -->
        <div class="header-login">
            <div id="user-info" class="header-user-info"></div>

            
            <button id="reloadDataBtn" class="btn btn-secondary" title="Reload news data" style="display:inline-flex; align-items:center;">
                ‚ü≥ Reload
            </button>
            
            <div id="g_id_onload"
                 data-client_id="752307788655-djf0dae2j8h10q040g1ombshla687l0j.apps.googleusercontent.com"
                 data-login_uri="https://azzamunza.github.io/mynews/oauth2callback.html"
                 data-auto_prompt="false"
                 data-callback="handleCredentialResponse">
            </div>
            <div class="g_id_signin" data-type="standard"></div>
        </div>
    </div>

    <!-- Style Selector Dropdown -->
    <div class="style-selector-container">
        <label for="styleSelector" class="style-selector-label">Theme:</label>
        <select id="styleSelector" class="style-selector">
            <option value="">Loading styles...</option>
        </select>
    </div>

    <!-- Desktop Navigation (moved inside header) -->
    <nav id="desktopNav">
        <div class="nav-container">
            <ul class="category-menu" id="categoryMenu">
                <li class="loading">Loading categories...</li>
            </ul>
        </div>
    </nav>
</header>

    <!-- Mobile Menu -->
    <div class="mobile-menu-overlay" id="mobileMenu">
        <div class="mobile-menu-header">
            <h2 style="color: var(--accent-color);">Menu</h2>
            <span class="mobile-menu-close" id="closeMobileMenu">&times;</span>
        </div>
        <ul class="mobile-menu-items" id="mobileMenuItems">
            <li class="loading">Loading...</li>
        </ul>
    </div>

    <div class="main-layout">
        <div class="content-area">
            <!-- Hero Carousel -->
            <section class="hero-section" id="heroSection" style="display: none;">
                <div class="carousel-container">
                    <div class="carousel-slides" id="carouselSlides"></div>
                    <div class="carousel-nav">
                        <button class="carousel-btn" id="carouselPrev">‚Äπ</button>
                        <button class="carousel-btn" id="carouselNext">‚Ä∫</button>
                    </div>
                    <div class="carousel-dots" id="carouselDots"></div>
                </div>
            </section>

            <!-- Article Grid -->
            <div class="article-grid" id="articleGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading articles...
                </div>
            </div>
        </div>

        <!-- Headlines Sidebar -->
        <aside class="headlines-sidebar">
            <h2 class="headlines-title">Headlines</h2>
            <div id="headlinesList">
                <div class="loading">Loading...</div>
            </div>
        </aside>
    </div>

    <!-- Article Modal -->
    <div class="modal" id="articleModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalContentArea"></div>
        </div>
    </div>

   <script>
    let isLoggedIn = false;
    let loggedInUserEmail = '';
    let articlesData = [], categoriesData = [], trendingData = [], videosData = [];
    let currentFilter = 'all', currentCarouselIndex = 0;
    let carouselInterval, makeWebhook = '', authToken = '';
    
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableStyles();
            loadNewsData();
            setupEventListeners();
        });
    
        // Load available styles dynamically from JSON
        async function loadAvailableStyles() {
            const styleSelector = document.getElementById('styleSelector');
            const stylesPath = './css/newsStyles/';
            const stylesJsonPath = './css/styles.json';
            
            try {
                // Fetch the styles configuration
                const response = await fetch(stylesJsonPath);
                
                if (!response.ok) {
                    throw new Error(`Failed to load styles.json: ${response.status}`);
                }
                
                const stylesConfig = await response.json();
                
                styleSelector.innerHTML = '';
                
                // Populate dropdown with styles from JSON
                stylesConfig.styles.forEach(style => {
                    const option = document.createElement('option');
                    option.value = stylesPath + style.file;
                    option.textContent = style.name;
                    option.setAttribute('data-description', style.description);
                    styleSelector.appendChild(option);
                });
                
                // Load saved preference or default style
                const savedStyle = localStorage.getItem('selectedStyle') || stylesPath + stylesConfig.default;
                styleSelector.value = savedStyle;
                loadStyle(savedStyle);
                
                // Add change event listener
                styleSelector.addEventListener('change', function() {
                    const selectedStyle = this.value;
                    loadStyle(selectedStyle);
                    localStorage.setItem('selectedStyle', selectedStyle);
                });
                
            } catch (error) {
                console.error('Error loading styles configuration:', error);
                
                // Fallback to hardcoded styles if JSON fails
                styleSelector.innerHTML = '<option value="./css/newsStyles/darkstyle.css">Dark Style</option>';
                const fallbackStyle = './css/newsStyles/darkstyle.css';
                styleSelector.value = fallbackStyle;
                loadStyle(fallbackStyle);
            }
        }
    
        function loadStyle(styleUrl) {
            const themeLink = document.getElementById('themeStylesheet');
            themeLink.href = styleUrl;
        }
    
        // Expose handleCredentialResponse globally so Google can call it
        function handleCredentialResponse(response) {
        const user = jwt_decode(response.credential);
        const userInfoDiv = document.getElementById('user-info');
        userInfoDiv.textContent = user.name;
    
        isLoggedIn = true;
        loggedInUserEmail = user.email;
    
        if (user.email === 'azzamunza@gmail.com') {
            const jobButtons = document.querySelectorAll('.btn-job');
            jobButtons.forEach(btn => btn.style.display = 'inline-block');
        }
    }
    
    function openModal(articleId) {
        const article = articlesData.find(a => a.id === articleId);
        if (!article) return;
    
        const modal = document.getElementById('articleModal');
        const modalContent = document.getElementById('modalContentArea');
    
        let badges = '';
        if (article.isTrending) badges += '<span class="badge badge-trending">üî• Trending</span>';
        if (article.isJob) badges += '<span class="badge badge-job">üíº Job Listing</span>';
        if (article.isVideo) badges += '<span class="badge badge-video">‚ñ∂ Video Content</span>';
    
        let videoEmbed = '';
        if (article.isVideo && article.videoUrl) {
            const videoId = extractYouTubeId(article.videoUrl);
            if (videoId) {
                videoEmbed = `<div class="video-player-container">
                    <iframe src="https://www.youtube.com/embed/${videoId}?rel=0" allowfullscreen
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                    </iframe>
                </div>`;
            }
        }
    
        let jobButton = '';
        if (article.isJob && makeWebhook && authToken && isLoggedIn && loggedInUserEmail === 'azzamunza@gmail.com') {
            jobButton = `<button class="btn btn-job" onclick="submitJobApplication(
                '${article.id}',
                '${escapeHtml(article.sourceUrl)}',
                '${escapeHtml(article.title)}'
            )">üíº Create Job Application</button>`;
        }
    
        const shareButtons = `
            <button class="btn btn-secondary" onclick="shareArticle('twitter','${escapeHtml(article.title)}','${escapeHtml(article.sourceUrl)}')">Share on Twitter</button>
            <button class="btn btn-secondary" onclick="shareArticle('linkedin','${escapeHtml(article.title)}','${escapeHtml(article.sourceUrl)}')">Share on LinkedIn</button>
            <button class="btn btn-secondary" onclick="copyToClipboard('${escapeHtml(article.sourceUrl)}')">üìã Copy Link</button>
        `;
    
        modalContent.innerHTML = `
            <img src="${article.bannerImage}" alt="${article.title}" class="modal-banner" loading="lazy">
            <div class="modal-body">
                <div class="modal-header-section">
                    <div class="modal-badges">${badges}</div>
                    <h1 class="modal-title">${article.title}</h1>
                    <div class="modal-meta">
                        <span>By ${article.author}</span>
                        <span>${article.date}</span>
                        <span>${article.readTime}</span>
                    </div>
                    <div class="modal-actions">
                        <a href="${article.sourceUrl}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">üì∞ Read Original Source</a>
                        ${jobButton}
                        ${shareButtons}
                    </div>
                </div>
                ${videoEmbed}
                <div class="modal-article-content">
                    ${article.fullContent}
                </div>
            </div>
        `;
    
        modal.classList.add('active');
    }
    
        function setupEventListeners() {
            document.getElementById('hamburgerMenu').addEventListener('click', toggleMobileMenu);
            document.getElementById('closeMobileMenu').addEventListener('click', toggleMobileMenu);
            document.getElementById('carouselPrev').addEventListener('click', () => changeSlide(-1));
            document.getElementById('carouselNext').addEventListener('click', () => changeSlide(1));
            
            document.getElementById('articleModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });
        }
    
        async function loadNewsData() {
            try {
                // Fetch the external JSON file
                const response = await fetch('news-data.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                categoriesData = data.categories || [];
                articlesData = data.articles || [];
                trendingData = data.trending || [];
                videosData = data.videos || [];
                makeWebhook = data.makeWebhook || '';
                authToken = data.authToken || '';
                
                renderCategories();
                renderCarousel();
                renderArticles();
                renderHeadlines();
                
            } catch (error) {
                console.error('Error loading news data:', error);
                showError(error.message);
            }
        }
    
        function showError(message) {
            document.getElementById('categoryMenu').innerHTML = 
                `<li style="color: var(--accent-color);">Error loading data: ${message}</li>`;
            document.getElementById('articleGrid').innerHTML = 
                `<div class="loading" style="color: var(--accent-color);">
                    <p>Error loading articles: ${message}</p>
                    <p style="font-size: 0.9rem; margin-top: 1rem;">Make sure news-data.json is in the same directory as this HTML file.</p>
                </div>`;
        }
    
        function renderCategories() {
            const desktopMenu = document.getElementById('categoryMenu');
            const mobileMenu = document.getElementById('mobileMenuItems');
            
            desktopMenu.innerHTML = '';
            mobileMenu.innerHTML = '';
            
            categoriesData.forEach(category => {
                // Desktop menu
                const li = document.createElement('li');
                li.className = 'category-item';
                const link = document.createElement('a');
                link.className = 'category-link' + (category.active ? ' active' : '');
                link.textContent = category.name;
                link.onclick = (e) => {
                    e.preventDefault();
                    filterByCategory(category.id);
                };
                li.appendChild(link);
                desktopMenu.appendChild(li);
                
                // Mobile menu
                const mli = document.createElement('li');
                mli.className = 'mobile-menu-item';
                const mlink = document.createElement('a');
                mlink.className = 'mobile-menu-link' + (category.active ? ' active' : '');
                mlink.textContent = category.name;
                mlink.onclick = (e) => {
                    e.preventDefault();
                    filterByCategory(category.id);
                    toggleMobileMenu();
                };
                mli.appendChild(mlink);
                mobileMenu.appendChild(mli);
            });
        }
    
        function renderCarousel() {
            const trendingArticles = articlesData.filter(a => a.isTrending);
            
            if (trendingArticles.length === 0 || currentFilter !== 'all') {
                document.getElementById('heroSection').style.display = 'none';
                return;
            }
            
            document.getElementById('heroSection').style.display = 'block';
            const slidesContainer = document.getElementById('carouselSlides');
            const dotsContainer = document.getElementById('carouselDots');
            
            slidesContainer.innerHTML = '';
            dotsContainer.innerHTML = '';
            
            trendingArticles.forEach((article, index) => {
                // Create slide
                const slide = document.createElement('div');
                slide.className = 'carousel-slide' + (index === 0 ? ' active' : '');
                slide.innerHTML = `
                    <img src="${article.bannerImage}" alt="${article.title}" loading="lazy">
                    <div class="carousel-content">
                        <span class="trending-badge">üî• Trending</span>
                        <h2 class="carousel-title">${article.title}</h2>
                        <p class="carousel-excerpt">${article.excerpt}</p>
                        <div class="carousel-meta">
                            <span>By ${article.author}</span>
                            <span>${article.date}</span>
                            <span>${article.readTime}</span>
                        </div>
                    </div>
                `;
                slide.onclick = () => openModal(article.id);
                slidesContainer.appendChild(slide);
                
                // Create dot
                const dot = document.createElement('div');
                dot.className = 'carousel-dot' + (index === 0 ? ' active' : '');
                dot.onclick = () => goToSlide(index);
                dotsContainer.appendChild(dot);
            });
            
            if (trendingArticles.length > 1) {
                startCarousel();
            }
        }
    
        function changeSlide(direction) {
            const slides = document.querySelectorAll('.carousel-slide');
            const dots = document.querySelectorAll('.carousel-dot');
            
            slides[currentCarouselIndex].classList.remove('active');
            dots[currentCarouselIndex].classList.remove('active');
            
            currentCarouselIndex = (currentCarouselIndex + direction + slides.length) % slides.length;
            
            slides[currentCarouselIndex].classList.add('active');
            dots[currentCarouselIndex].classList.add('active');
            
            resetCarousel();
        }
    
        function goToSlide(index) {
            const slides = document.querySelectorAll('.carousel-slide');
            const dots = document.querySelectorAll('.carousel-dot');
            
            slides[currentCarouselIndex].classList.remove('active');
            dots[currentCarouselIndex].classList.remove('active');
            
            currentCarouselIndex = index;
            
            slides[currentCarouselIndex].classList.add('active');
            dots[currentCarouselIndex].classList.add('active');
            
            resetCarousel();
        }
    
        function startCarousel() {
            carouselInterval = setInterval(() => {
                changeSlide(1);
            }, 5000);
        }
    
        function resetCarousel() {
            clearInterval(carouselInterval);
            startCarousel();
        }
    
        function renderArticles(filterCategory = 'all') {
            const gridContainer = document.getElementById('articleGrid');
            gridContainer.innerHTML = '';
            
            const filteredArticles = filterCategory === 'all' 
                ? articlesData 
                : articlesData.filter(article => article.category === filterCategory);
            
            if (filteredArticles.length === 0) {
                gridContainer.innerHTML = '<div class="loading">No articles found in this category.</div>';
                return;
            }
            
            filteredArticles.forEach(article => {
                const card = document.createElement('div');
                card.className = 'article-card';
                card.setAttribute('data-category', article.category);
                
                let badges = '';
                if (article.isTrending) badges += '<span class="badge badge-trending">üî• Trending</span>';
                if (article.isJob) badges += '<span class="badge badge-job">üíº Job</span>';
                if (article.isVideo) badges += '<span class="badge badge-video">‚ñ∂ Video</span>';
                
                const imageHtml = article.isVideo 
                    ? `<div class="video-thumbnail">
                         <img src="${article.thumbnailImage}" alt="${article.title}" class="article-image" loading="lazy">
                         <div class="video-play-icon">‚ñ∂</div>
                       </div>`
                    : `<img src="${article.thumbnailImage}" alt="${article.title}" class="article-image" loading="lazy">`;
                
                card.innerHTML = `
                    <div class="article-image-container">
                        ${imageHtml}
                        <div class="article-badges">${badges}</div>
                    </div>
                    <div class="article-content">
                        <span class="article-category">${article.category}</span>
                        <h2 class="article-title">${article.title}</h2>
                        <p class="article-excerpt">${article.excerpt}</p>
                        <div class="article-meta">
                            <span>${article.author}</span>
                            <span>${article.date}</span>
                        </div>
                    </div>
                `;
                
                card.onclick = () => openModal(article.id);
                gridContainer.appendChild(card);
            });
        }
    
        function renderHeadlines() {
            const headlinesList = document.getElementById('headlinesList');
            headlinesList.innerHTML = '';
            
            const recentArticles = articlesData.slice(0, 10);
            
            recentArticles.forEach(article => {
                const headline = document.createElement('div');
                headline.className = 'headline-item';
                headline.innerHTML = `
                    <div class="headline-category">${article.category}</div>
                    <div class="headline-title">${article.title}</div>
                    <div class="headline-time">${article.date}</div>
                `;
                headline.onclick = () => openModal(article.id);
                headlinesList.appendChild(headline);
            });
        }
    
        function filterByCategory(category) {
            currentFilter = category;
            
            document.querySelectorAll('.category-link, .mobile-menu-link').forEach(link => {
                link.classList.remove('active');
            });
            
            document.querySelectorAll('.category-link, .mobile-menu-link').forEach(link => {
                if (link.textContent.toLowerCase() === categoriesData.find(c => c.id === category)?.name.toLowerCase()) {
                    link.classList.add('active');
                }
            });
            
            renderCarousel();
            renderArticles(category);
        }
    
        function openModal(articleId) {
            const article = articlesData.find(a => a.id === articleId);
            if (!article) return;
            
            const modal = document.getElementById('articleModal');
            const modalContent = document.getElementById('modalContentArea');
            
            let badges = '';
            if (article.isTrending) badges += '<span class="badge badge-trending">üî• Trending</span>';
            if (article.isJob) badges += '<span class="badge badge-job">üíº Job Listing</span>';
            if (article.isVideo) badges += '<span class="badge badge-video">‚ñ∂ Video Content</span>';
            
            let videoEmbed = '';
            if (article.isVideo && article.videoUrl) {
                const videoId = extractYouTubeId(article.videoUrl);
                if (videoId) {
                    videoEmbed = `
                        <div class="video-player-container">
                            <iframe src="https://www.youtube.com/embed/${videoId}?rel=0" 
                                    allowfullscreen 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                            </iframe>
                        </div>
                    `;
                }
            }
            
            let jobButton = '';
            if (article.isJob && makeWebhook && authToken) {
                jobButton = `
                    <button class="btn btn-job" onclick="submitJobApplication(
                        '${article.id}',
                        '${escapeHtml(article.sourceUrl)}',
                        '${escapeHtml(article.title)}'
                    )">
                        üíº Create Job Application
                    </button>
                `;
            } else {
                // Ensure button is hidden if not logged in
                jobButton = '';
            }
    
            
            const shareButtons = `
                <button class="btn btn-secondary" onclick="shareArticle('twitter', '${escapeHtml(article.title)}', '${escapeHtml(article.sourceUrl)}')">
                    Share on Twitter
                </button>
                <button class="btn btn-secondary" onclick="shareArticle('linkedin', '${escapeHtml(article.title)}', '${escapeHtml(article.sourceUrl)}')">
                    Share on LinkedIn
                </button>
                <button class="btn btn-secondary" onclick="copyToClipboard('${escapeHtml(article.sourceUrl)}')">
                    üìã Copy Link
                </button>
            `;
            
            modalContent.innerHTML = `
                <img src="${article.bannerImage}" alt="${article.title}" class="modal-banner" loading="lazy">
                <div class="modal-body">
                    <div class="modal-header-section">
                        <div class="modal-badges">${badges}</div>
                        <h1 class="modal-title">${article.title}</h1>
                        <div class="modal-meta">
                            <span>By ${article.author}</span>
                            <span>${article.date}</span>
                            <span>${article.readTime}</span>
                        </div>
                        <div class="modal-actions">
                            <a href="${article.sourceUrl}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">
                                üì∞ Read Original Source
                            </a>
                            ${jobButton}
                            ${shareButtons}
                        </div>
                    </div>
                    ${videoEmbed}
                    <div class="modal-article-content">
                        ${article.fullContent}
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }
    
        function closeModal() {
            const modal = document.getElementById('articleModal');
            modal.classList.remove('active');
        }
    
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('active');
        }
    
        function extractYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }
    
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    
        async function submitJobApplication(articleId, jobUrl, jobTitle) {
            if (!makeWebhook || !authToken) {
                alert('Job application system not configured.');
                return;
            }
            
            const confirmed = confirm(`Submit job application for: ${jobTitle}?`);
            if (!confirmed) return;
            
            try {
                const response = await fetch(makeWebhook, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        articleId: articleId,
                        jobUrl: jobUrl,
                        jobTitle: jobTitle,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    alert('‚úÖ Job application submitted successfully!');
                } else {
                    throw new Error('Failed to submit');
                }
            } catch (error) {
                console.error('Error submitting job application:', error);
                alert('‚ùå Failed to submit job application. Please try again.');
            }
        }
    
        function shareArticle(platform, title, url) {
            const encodedTitle = encodeURIComponent(title);
            const encodedUrl = encodeURIComponent(url);
            
            let shareUrl = '';
            
            if (platform === 'twitter') {
                shareUrl = `https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}`;
            } else if (platform === 'linkedin') {
                shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }
        }
    
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Link copied to clipboard!');
            }).catch(() => {
                alert('‚ùå Failed to copy link');
            });
        }
    
        (function () {
          const btn = document.getElementById('reloadDataBtn');
          if (!btn) return;
        
          // Small helper to set temporary busy state
          function setWorking(isWorking) {
            if (isWorking) {
              btn.disabled = true;
              btn.dataset.origText = btn.textContent;
              btn.textContent = 'Reloading...';
              btn.style.opacity = '0.8';
            } else {
              btn.disabled = false;
              btn.textContent = btn.dataset.origText || '‚ü≥ Reload';
              btn.style.opacity = '';
            }
          }
        
          async function reloadNewsData() {
            setWorking(true);
            try {
              // First, reload the styles configuration
              await loadAvailableStyles();
              
              // Then fetch fresh news data with no-cache to ensure latest copy is retrieved
              const resp = await fetch('./news-data.json', { cache: 'no-store' });
              if (!resp.ok) throw new Error('Failed to fetch news-data.json: ' + resp.status);
        
              const json = await resp.json();
        
              // Update global data
              categoriesData = json.categories || [];
              articlesData = json.articles || [];
              trendingData = json.trending || [];
              videosData = json.videos || [];
              makeWebhook = json.makeWebhook || '';
              authToken = json.authToken || '';
              
              // Re-render all components
              renderCategories();
              renderCarousel();
              renderArticles(currentFilter);
              renderHeadlines();
              
              // Show success message
              console.log('‚úÖ Data and styles reloaded successfully!');
              
            } catch (err) {
              console.error(err);
              alert('Error reloading data: ' + (err.message || err));
            } finally {
              setWorking(false);
            }
          }
        
          btn.addEventListener('click', reloadNewsData);
        })();
    </script>
</body>
</html>


